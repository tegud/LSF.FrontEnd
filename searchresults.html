<!DOCTYPE html>
<html lang="en">
<head>
    <script src="assets/js/elasticsearch.js" type="text/javascript"></script>
    <script src="assets/js/mustache.js" type="text/javascript"></script>
    <script src="assets/js/moment.js" type="text/javascript"></script>
    <script type="text/javascript">
var flight_hauls = {
    short: 40,
    mid: 60
};
        
var destination_hauls = {
    AYT: flight_hauls.mid
};
    </script>
    <script id="template" type="x-tmpl-mustache">
    {{#results}}
    <div class="result-row">
        <div class="destInfo">
            {{departure_airport}}
        </div>

        <div class="destInfo">
            {{destination_airport}}
        </div>
        <div class="destInfo">
            {{arrival_date}}
        </div>
        <div class="destInfo">
            {{departure_date}}
        </div>
        <div class="destInfo">
            {{nights}}
        </div>
        <div class="destInfo">
            {{seats_remaining}}
        </div>
        <div class="destInfo">
            {{price}}
        </div>
        <div class="destInfo">
            <button class="watchButton"><a href="myflights.html?flightid={{flightid}}">watch</a></button>
        </div>
    </div>
{{/results}}
    </script>
    <script type="text/javascript">
var flight_hauls = {
    short: 40,
    mid: 60
};
        
var destination_hauls = {
    AYT: 60,
    PMI: 40
};
        console.log(destination_hauls);
        var params = {};
        var qs = window.location.search.substring(1).split(/&/);
        for (var i in qs) {
            var m = qs[i].split(/=/);
            params[m[0]] = m[1];
        }
console.log(params);

        var client = new elasticsearch.Client({
          host: '10.44.35.21:9200',
          log: 'trace'
        });

        var query = {
                "filtered": {
                  "filter": {
                    "bool": {
                      "must": [
                      	{
                      		"range": {
                      			"seats_remaining": { "gte": 1 } 
                      		}	
                      	}
                      ]
                    }
                  }
                }
             };
        
        if (params.departure_airport) {
            query.filtered.filter.bool.must.push(
                        {
                            "term": {
                                "departure_airport.code.raw": params.departure_airport
                            }
                        }
            );
        }
        
        if (params.destination_airport) {
            query.filtered.filter.bool.must.push(
                        {
                            "term": {
                                "destination_airport.code.raw": params.destination_airport
                            }
                        }
            );
        }
        /*
                        {
                            "term": {
                                "departure_airport.code.raw": "MAN"
                            }
                        },
                        {
                            "term": {"destination_airport.code.raw":"PMI"}
                        }
                      */
        
        if (query.filtered.filter.bool.must.length == 0) {
            query = {};
        }
        
         client.search({
          index: 'lateseats',
          type: 'flight',
             body: {
                 query: query,
                 "size": 1000,
                 "sort" : [
        					{ "seats_remaining" : {"order" : "asc"}} 
      					]
          }
        }).then(function (resp) {
            var hits = resp.hits.hits;
             console.log(hits);
             var results = {results:[]};
             for (hit in hits) {
                 if (!hits.hasOwnProperty(hit)) continue;
                 var h = hits[hit]._source;
                results.results.push({
                    departure_airport: h.departure_airport.name,
                    destination_airport: h.destination_airport.name,
                    departure_date: moment(h.departure_date).format('DD MMM YYYY HH:mm'),
                    arrival_date: moment(h.arrival_date).format('DD MMM YYYY HH:mm'),
                    nights: h.nights,
                    seats_remaining: h.seats_remaining,
                    price: ~~destination_hauls[h.destination_airport.code],
                    flightid: hits[hit]._id
                });
             }
             templateShizzle(results);
        }, function (err) {
            console.trace(err.message);
        });
        
        function templateShizzle(data) {
            var template = document.getElementById("template").innerHTML;
            Mustache.parse(template);
            var rendered = Mustache.render(template, data);
            document.getElementById("results").innerHTML = rendered;
        }

    </script>
<meta charset="utf-8" />
<title>LateSeats Search Results</title>

<link rel="stylesheet" type="text/css" href="assets/css/style.css" />
</head>
<body id="searchresults">
    <div id="main">
    <header class="header"><nav><h1>LateSeats Finder</h1></nav></header>
        <div class="contanierSearchRsults">
            <section class="searchheader">
                <div class="box">from</div>
                <div class="box">to</div>
                <div class="box">outbound</div>
                <div class="box">inbound</div>
                <div class="box">nights</div>
                <div class="box">No of seats</div>
                <div class="box">price</div>
                <div class="box boxLarge">watch this flight</div>
            </section>
            <section class="resultsrows">
                <div id="results" class="resultsrow"></div>
            </section>
        <div>
    </div>    
</body>
</html>